name: ðŸ“¦ Release et Changelog PCR

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    name: ðŸš€ Create Release and Deploy Changelog
    runs-on: self-hosted
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“‹ Install dependencies
        run: npm ci
        
      - name: ðŸ—ï¸ Build and prepare
        run: |
          echo "ðŸ—ï¸ PrÃ©paration de la release..."
          npm audit fix --force || true
          
      - name: ðŸ“ Extract version and prepare release notes
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Version dÃ©tectÃ©e: $VERSION"
          
          # GÃ©nÃ©rer les notes de release depuis changelog.json
          if [ -f "changelog.json" ]; then
            echo "ðŸ“‹ GÃ©nÃ©ration des notes depuis changelog.json..."
            node -e "
              const fs = require('fs');
              try {
                const changelog = JSON.parse(fs.readFileSync('changelog.json', 'utf8'));
                const release = changelog.releases.find(r => r.version === '$VERSION');
                
                if (release) {
                  let notes = \`## ðŸŽ‰ \${release.title || 'Release ' + release.version}\\n\\n\`;
                  
                  if (release.features && release.features.length > 0) {
                    const featuresByType = release.features.reduce((acc, f) => {
                      if (!acc[f.type]) acc[f.type] = [];
                      acc[f.type].push(f);
                      return acc;
                    }, {});
                    
                    Object.entries(featuresByType).forEach(([type, features]) => {
                      const typeTitle = {
                        'command': 'âš¡ Nouvelles Commandes',
                        'event': 'ðŸŽ¯ Nouveaux Ã‰vÃ©nements', 
                        'feature': 'âœ¨ Nouvelles FonctionnalitÃ©s',
                        'fix': 'ðŸ› Corrections',
                        'enhancement': 'ðŸ”§ AmÃ©liorations'
                      }[type] || 'ðŸ“‹ Autres';
                      
                      notes += \`### \${typeTitle}\\n\\n\`;
                      features.forEach(f => {
                        notes += \`- **\${f.name}**: \${f.description}\`;
                        if (f.author) notes += \` (par \${f.author})\`;
                        notes += \`\\n\`;
                      });
                      notes += \`\\n\`;
                    });
                  }
                  
                  notes += \`### ðŸš€ Installation rapide\\n\\n\`;
                  notes += \`\\\`\\\`\\\`bash\\n\`;
                  notes += \`git clone https://github.com/sydnec/PCR.git\\n\`;
                  notes += \`cd PCR\\n\`;
                  notes += \`./pcr deploy\\n\`;
                  notes += \`\\\`\\\`\\\`\\n\`;
                  
                  fs.writeFileSync('RELEASE_NOTES.md', notes);
                  console.log('âœ… Notes de release gÃ©nÃ©rÃ©es depuis changelog.json');
                } else {
                  throw new Error('Release non trouvÃ©e dans changelog.json');
                }
              } catch (error) {
                console.log('âš ï¸ Erreur avec changelog.json, utilisation du fallback:', error.message);
                const fallback = \`## ðŸŽ‰ PCR Bot v\${process.env.VERSION}\\n\\nNouvelle version du bot Discord PCR.\\n\\n### ðŸš€ Installation\\n\\n\\\`\\\`\\\`bash\\ngit clone https://github.com/sydnec/PCR.git\\ncd PCR\\n./pcr deploy\\n\\\`\\\`\\\`\`;
                require('fs').writeFileSync('RELEASE_NOTES.md', fallback);
              }
            "
          else
            echo "âš ï¸ changelog.json non trouvÃ©, gÃ©nÃ©ration de notes basiques..."
            cat > RELEASE_NOTES.md << EOF
          ## ðŸŽ‰ PCR Bot v$VERSION
          
          Nouvelle version du bot Discord PCR.
          
          ### ðŸš€ Installation rapide
          
          \`\`\`bash
          git clone https://github.com/sydnec/PCR.git
          cd PCR
          ./pcr deploy
          \`\`\`
          EOF
          fi
          
      - name: ðŸ“¦ Create Release Archive
        run: |
          echo "ðŸ“¦ CrÃ©ation de l'archive de release..."
          # CrÃ©er un rÃ©pertoire temporaire pour l'archive
          mkdir -p /tmp/pcr-release
          
          # Copier les fichiers nÃ©cessaires en excluant les rÃ©pertoires/fichiers indÃ©sirables
          rsync -av --progress \
            --exclude='.git/' \
            --exclude='node_modules/' \
            --exclude='.github/' \
            --exclude='backups/' \
            --exclude='logs/' \
            --exclude='*.db' \
            --exclude='.env' \
            --exclude='*.tar.gz' \
            --exclude='/tmp/' \
            ./ /tmp/pcr-release/
          
          # CrÃ©er l'archive depuis le rÃ©pertoire temporaire
          cd /tmp
          tar -czf pcr-bot-v${{ steps.version.outputs.VERSION }}.tar.gz pcr-release/
          
          # DÃ©placer l'archive vers le rÃ©pertoire de travail
          mv pcr-bot-v${{ steps.version.outputs.VERSION }}.tar.gz $GITHUB_WORKSPACE/
          
          # Nettoyer le rÃ©pertoire temporaire
          rm -rf /tmp/pcr-release
          
          echo "âœ… Archive crÃ©Ã©e: pcr-bot-v${{ steps.version.outputs.VERSION }}.tar.gz"
            
      - name: ðŸš€ Create GitHub Release
        id: create_release
        run: |
          echo "ðŸš€ CrÃ©ation de la release GitHub..."
          
          # CrÃ©er la release avec GitHub CLI
          gh release create "v${{ steps.version.outputs.VERSION }}" \
            --title "ðŸ¤– PCR Bot v${{ steps.version.outputs.VERSION }}" \
            --notes-file RELEASE_NOTES.md \
            --target main \
            ./pcr-bot-v${{ steps.version.outputs.VERSION }}.tar.gz
          
          echo "âœ… Release v${{ steps.version.outputs.VERSION }} crÃ©Ã©e avec succÃ¨s"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸš€ Deploy to Production Server
        id: deploy
        run: |
          echo "ðŸš€ DÃ©ploiement automatique (self-hosted runner)..."
          
          # Naviguer vers le rÃ©pertoire du projet (mÃªme serveur)
          cd ${{ github.workspace }}
          echo "ðŸ“ RÃ©pertoire de projet: $(pwd)"
          
          # Basculer vers le nouveau tag
          echo "ðŸ·ï¸ Basculement vers le tag v${{ steps.version.outputs.VERSION }}..."
          git checkout v${{ steps.version.outputs.VERSION }}
          
          # Mettre Ã  jour les dÃ©pendances si nÃ©cessaire
          if git diff HEAD~1 HEAD --name-only | grep -q package.json; then
            echo "ðŸ“¦ package.json modifiÃ©, mise Ã  jour des dÃ©pendances..."
            npm install
          fi
          
          # RedÃ©marrer le bot avec PM2
          echo "ðŸ”„ RedÃ©marrage du bot PCR..."
          pm2 restart pcr || {
            echo "âš ï¸ Erreur lors du restart, tentative de start..."
            pm2 start index.js --name pcr
          }
          
          # Sauvegarder la configuration PM2
          pm2 save
          
          # VÃ©rifier que le bot est en ligne
          sleep 5
          if pm2 list | grep -q "pcr.*online"; then
            echo "âœ… Bot PCR redÃ©marrÃ© avec succÃ¨s sur la version v${{ steps.version.outputs.VERSION }}"
          else
            echo "âŒ Erreur: Le bot n'est pas en ligne aprÃ¨s le redÃ©marrage"
            pm2 logs pcr --lines 10
            exit 1
          fi
          
          echo "ðŸŽ‰ DÃ©ploiement automatique terminÃ© avec succÃ¨s !"

      - name: âœ… Release Summary
        if: success()
        run: |
          echo "ðŸŽ‰ Release v${{ steps.version.outputs.VERSION }} crÃ©Ã©e et dÃ©ployÃ©e avec succÃ¨s !"
          echo ""
          echo "ðŸ“‹ RÃ©sumÃ©:"
          echo "  â€¢ Version: ${{ steps.version.outputs.VERSION }}"
          echo "  â€¢ Tag: v${{ steps.version.outputs.VERSION }}"
          echo "  â€¢ Archive: pcr-bot-v${{ steps.version.outputs.VERSION }}.tar.gz"
          echo "  â€¢ Release GitHub: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}"
          echo "  â€¢ DÃ©ploiement: âœ… Automatique sur serveur de production"
          echo ""
          echo "ðŸš€ Actions automatiques rÃ©alisÃ©es:"
          echo "  â€¢ âœ… Release GitHub crÃ©Ã©e"
          echo "  â€¢ âœ… Code dÃ©ployÃ© sur le serveur de production"
          echo "  â€¢ âœ… Bot PCR redÃ©marrÃ© avec la nouvelle version"
          echo "  â€¢ âœ… Notifications Discord prÃªtes (si configurÃ©es)"
          echo ""
          echo "ðŸ’¡ Le bot est maintenant opÃ©rationnel avec la version v${{ steps.version.outputs.VERSION }}"
          
      - name: âŒ Deploy Failure Notification
        if: failure()
        run: |
          echo "âŒ Ã‰chec du dÃ©ploiement de la version v${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "ðŸ” VÃ©rifications nÃ©cessaires:"
          echo "  â€¢ Connexion SSH au serveur de production"
          echo "  â€¢ Configuration des secrets GitHub"
          echo "  â€¢ Ã‰tat du serveur et de PM2"
          echo ""
          echo "ðŸ“ž Action manuelle requise pour finaliser le dÃ©ploiement"
