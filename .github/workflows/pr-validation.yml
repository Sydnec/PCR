name: ğŸ” Pull Request Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: ğŸ” Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“‹ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run tests
        run: npm test
        
      - name: ğŸ” Lint code
        run: npm run lint
        
      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=moderate
        
      - name: ğŸ“Š Check PR size
        run: |
          echo "ğŸ“Š Analyse de la taille de la PR..."
          
          # Compter les fichiers modifiÃ©s
          files_changed=$(git diff --name-only origin/main...HEAD | wc -l)
          lines_added=$(git diff --numstat origin/main...HEAD | awk '{sum+=$1} END {print sum}')
          lines_removed=$(git diff --numstat origin/main...HEAD | awk '{sum+=$2} END {print sum}')
          
          echo "ğŸ“ Fichiers modifiÃ©s: $files_changed"
          echo "â• Lignes ajoutÃ©es: $lines_added"
          echo "â– Lignes supprimÃ©es: $lines_removed"
          
          # Alertes pour les grosses PR
          if [ "$files_changed" -gt 20 ]; then
            echo "âš ï¸ PR importante: $files_changed fichiers modifiÃ©s"
          fi
          
          if [ "$lines_added" -gt 500 ]; then
            echo "âš ï¸ PR importante: $lines_added lignes ajoutÃ©es"
          fi
          
      - name: ğŸ“ Check commit messages
        run: |
          echo "ğŸ“ VÃ©rification des messages de commit..."
          
          # VÃ©rifier les messages de commit depuis main
          commits=$(git log --oneline origin/main...HEAD)
          
          if [ -z "$commits" ]; then
            echo "âš ï¸ Aucun commit trouvÃ©"
            exit 1
          fi
          
          echo "ğŸ“‹ Commits dans cette PR:"
          echo "$commits"
          
          # VÃ©rifier le format des commits
          while read -r line; do
            if [[ -n "$line" ]]; then
              commit_msg=$(echo "$line" | cut -d' ' -f2-)
              echo "VÃ©rification: $commit_msg"
              
              # VÃ©rifier si le commit suit une convention basique
              if [[ "$commit_msg" =~ ^(feat|fix|docs|style|refactor|test|chore): ]]; then
                echo "âœ… Format de commit conventionnel dÃ©tectÃ©"
              else
                echo "â„¹ï¸ Format de commit libre (acceptable)"
              fi
            fi
          done <<< "$commits"
          
      - name: ğŸ” Check for sensitive files
        run: |
          echo "ğŸ” VÃ©rification des fichiers sensibles..."
          
          # Fichiers Ã  Ã©viter dans les commits
          sensitive_patterns="\.env$ \.env\. token secret password key \.pem$ \.key$"
          
          for pattern in $sensitive_patterns; do
            if git diff --name-only origin/main...HEAD | grep -E "$pattern"; then
              echo "âŒ Fichier sensible dÃ©tectÃ©: $pattern"
              echo "âš ï¸ VÃ©rifiez que vous n'exposez pas de secrets"
              exit 1
            fi
          done
          
          echo "âœ… Aucun fichier sensible dÃ©tectÃ©"
          
      - name: ğŸ“Š Generate PR report
        run: |
          echo "ğŸ“Š Rapport de la Pull Request"
          echo "============================="
          echo "ğŸ·ï¸ Branche: ${{ github.head_ref }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
          echo "ğŸ“… Date: $(date)"
          echo ""
          
          echo "ğŸ“ˆ Statistiques:"
          echo "- Fichiers modifiÃ©s: $(git diff --name-only origin/main...HEAD | wc -l)"
          echo "- Lignes ajoutÃ©es: $(git diff --numstat origin/main...HEAD | awk '{sum+=$1} END {print sum}')"
          echo "- Lignes supprimÃ©es: $(git diff --numstat origin/main...HEAD | awk '{sum+=$2} END {print sum}')"
          echo ""
          
          echo "ğŸ“ Fichiers modifiÃ©s:"
          git diff --name-only origin/main...HEAD | while read file; do
            echo "  - $file"
          done
          echo ""
          
          echo "âœ… Validation rÃ©ussie - PR prÃªte pour review!"

  # Job optionnel pour commenter la PR
  comment:
    name: ğŸ’¬ Comment PR  
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.action == 'opened'
    
    steps:
      - name: ğŸ’¬ Welcome comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ Merci pour votre contribution au PCR Bot!

            Cette Pull Request a Ã©tÃ© automatiquement validÃ©e. Voici quelques informations utiles:

            ## ğŸ” VÃ©rifications automatiques
            - âœ… Tests de syntaxe
            - âœ… Tests fonctionnels
            - âœ… Audit de sÃ©curitÃ©
            - âœ… VÃ©rification des fichiers sensibles

            ## ğŸ“‹ Checklist pour le review
            - [ ] La fonctionnalitÃ© fonctionne comme attendu
            - [ ] Le code est bien documentÃ©  
            - [ ] Les tests passent
            - [ ] Pas de rÃ©gression dÃ©tectÃ©e

            ## ğŸš€ Tests manuels
            Pour tester cette PR localement:
            \`\`\`bash
            git checkout ${{ github.head_ref }}
            ./pcr deploy
            ./pcr dev
            \`\`\`

            Un mainteneur va examiner votre PR bientÃ´t. Merci! ğŸ™`
            })
