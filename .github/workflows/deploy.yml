name: Deploy to Production

on:
  push:
    tags:
      - 'v*' # Se dÃ©clenche uniquement sur les tags de version (ex: v1.0.0)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            # ArrÃªt en cas d'erreur
            set -e
            
            echo "ðŸš€ DÃ©but du dÃ©ploiement sur le serveur..."
            
            # Aller dans le dossier du projet
            # NOTE: Assurez-vous que ce chemin est correct
            cd /home/sydnec/pcr
            
            # Mettre Ã  jour le code source (le tag qui vient d'Ãªtre pushÃ©)
            echo "ðŸ“¥ RÃ©cupÃ©ration de la derniÃ¨re version..."
            git fetch --all --tags
            git checkout main
            git pull origin main
            
            # Lancer le script de dÃ©ploiement interne
            # Cela gÃ¨re npm install et le redÃ©marrage PM2
            echo "ðŸ”„ ExÃ©cution du script de dÃ©ploiement..."
            bash ./pcr deploy
            
            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
