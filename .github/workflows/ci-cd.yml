name: ğŸ¤– PCR Bot CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job de tests et validation
  test:
    name: ğŸ§ª Tests et validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“‹ Install dependencies
        run: npm ci
        
      - name: ğŸ” Lint code
        run: npm run lint || echo "âš ï¸ Pas de script lint configurÃ©"
        
      - name: ğŸ§ª Run tests
        run: npm test
        
      - name: ğŸ”’ Audit dependencies
        run: npm audit --audit-level=moderate
        
      - name: âœ… Validate Discord.js syntax
        run: node -c index.js

  # Job de build et vÃ©rification
  build:
    name: ğŸ—ï¸ Build validation
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“‹ Install dependencies
        run: npm ci
        
      - name: ğŸ” Check for missing dependencies
        run: |
          echo "ğŸ” VÃ©rification des imports..."
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            function checkImports(dir) {
              const files = fs.readdirSync(dir, { withFileTypes: true });
              
              for (const file of files) {
                const fullPath = path.join(dir, file.name);
                
                if (file.isDirectory() && file.name !== 'node_modules') {
                  checkImports(fullPath);
                } else if (file.name.endsWith('.js')) {
                  try {
                    const content = fs.readFileSync(fullPath, 'utf8');
                    // VÃ©rification basique des imports
                    if (content.includes('import') || content.includes('require')) {
                      console.log(\`âœ… \${fullPath} - Imports dÃ©tectÃ©s\`);
                    }
                  } catch (error) {
                    console.log(\`âŒ \${fullPath} - Erreur: \${error.message}\`);
                  }
                }
              }
            }
            
            checkImports('.');
            console.log('âœ… VÃ©rification terminÃ©e');
          "

  # Job de dÃ©ploiement (seulement sur main)
  deploy:
    name: ğŸš€ Deploy to production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to server
        run: |
          echo "ğŸš€ DÃ©ploiement en production..."
          echo "âš ï¸ Configuration du dÃ©ploiement SSH nÃ©cessaire"
          echo "ğŸ“‹ Ã‰tapes Ã  configurer:"
          echo "  1. Ajouter SSH_HOST, SSH_USER, SSH_KEY dans les secrets GitHub"
          echo "  2. Configurer l'accÃ¨s SSH au serveur"
          echo "  3. DÃ©commenter les Ã©tapes de dÃ©ploiement ci-dessous"
          
      # DÃ©commentez et configurez ces Ã©tapes pour le dÃ©ploiement automatique
      # - name: ğŸ” Setup SSH
      #   uses: webfactory/ssh-agent@v0.8.0
      #   with:
      #     ssh-private-key: ${{ secrets.SSH_KEY }}
      #     
      # - name: ğŸš€ Deploy via SSH
      #   run: |
      #     ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
      #       cd /path/to/your/PCR
      #       git pull origin main
      #       ./pcr update
      #     EOF

  # Job de notification
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Success notification
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi!"
          echo "âœ… Tests: ${{ needs.test.result }}"
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "âœ… Deploy: ${{ needs.deploy.result }}"
          
      - name: âŒ Failure notification  
        if: needs.test.result == 'failure' || needs.build.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          echo "âŒ Ã‰chec du workflow!"
          echo "ğŸ§ª Tests: ${{ needs.test.result }}"
          echo "ğŸ—ï¸ Build: ${{ needs.build.result }}"
          echo "ğŸš€ Deploy: ${{ needs.deploy.result }}"
